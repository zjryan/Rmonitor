<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>服务器性能监控</title>
    <link href="../static/bootstrap.min.css" rel="stylesheet">
    <script src="../static/jquery.js"></script>
    <script src="../static/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.js"></script>
    <script>
        var labelLength = 30;
        var cpuChart;

        var createCPUChart = function (min1, min5, min15) {
            var labels = new Array(labelLength);
            for(var i = 0; i < 30; i++) {
                labels[i] = i*2;
            }

            var d = {
                labels: labels,
                datasets: [
                    {
                        label: "1分钟平均负载",
                        data: min1,
                        backgroundColor: "rgba(135,206,250,0.2)",
                        borderColor: "rgba(135,206,250,1)",
                        pointBorderColor: "rgba(135,206,250,1)",
                        pointBackgroundColor: "#fff",
                        pointBorderWidth: 2,
                    },
                    {
                        label: "5分钟平均负载",
                        data: min5,
                        backgroundColor: "rgba(153,204,255,0.3)",
                        borderColor: "rgba(153,204,255,1)",
                        pointBorderColor: "rgba(153,204,255,1)",
                        pointBackgroundColor: "#fff",
                        pointBorderWidth: 2,
                    },
                    {
                        label: "15分钟平均负载",
                        data: min15,
                        backgroundColor: "rgba(200,200,200,0.4)",
                        borderColor: "rgba(200,200,200,1)",
                        pointBorderColor: "rgba(200,200,200,1)",
                        pointBackgroundColor: "#fff",
                        pointBorderWidth: 2,
                    }
                ]
            };

            var options = {
                responsive: false,
                animation : false,
                scales: {
                    xAxes: [{
                        display: false
                    }],
                    yAxes: [{}]
                }
            };

            var cpuLineChart = {
                type: 'line',
                data: d,
                options: options
            };
            var ctx = $('#cpuChart').get(0);
            cpuChart = new Chart(ctx, cpuLineChart);
        };

        var updateCPUChart = function (min1, min5, min15) {
            var cpuData = cpuChart.data;
            var datasetMin1 = cpuData.datasets[0];
            var datasetMin5 = cpuData.datasets[1];
            var datasetMin15 = cpuData.datasets[2];
            datasetMin1.data = min1;
            datasetMin5.data = min5;
            datasetMin15.data = min15;
            cpuChart.update();
        };

        var createChart = function () {
            var form = {
                'data_len': labelLength,
            };
            var success = function (r) {
                if (r.success) {
                    log('success');
                    var min1 = r.data.cpu_min1;
                    var min5 = r.data.cpu_min5;
                    var min15 = r.data.cpu_min15;
                    createCPUChart(min1, min5, min15);
                } else {
                    log('failed');
                }
            };
            var error = function (err) {
                log(err);
            };
            chart.serverStatus(form, success, error)
        };

        var updateChart = function () {
            var form = {
                'data_len': labelLength,
            };
            var success = function (r) {
                if (r.success) {
                    log('success');
                    var min1 = r.data.cpu_min1;
                    var min5 = r.data.cpu_min5;
                    var min15 = r.data.cpu_min15;
                    updateCPUChart(min1, min5, min15);
                } else {
                    log('failed');
                }
            };
            var error = function (err) {
                log(err);
            };
            chart.serverStatus(form, success, error)
        };

        var __main = function () {
            createChart();
            setInterval(function () {
                updateChart();
            }, 2000);
        };

        $(document).ready(function () {
            __main();
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>服务器信息</h1>
        <h3>CPU</h3>
        <canvas id="cpuChart" width="800" height="400"></canvas>
        <h3>Memory</h3>
        <canvas id="memoryChart" width="800" height="400"></canvas>
    </div>
</body>
</html>